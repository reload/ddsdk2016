<?php

/**
 * @file
 * Hooks and functionality for the Track universe.
 */

use Drupal\node\Entity\Node;

/**
 * Implements hook_preprocess_HOOK().
 *
 * Prepare the html for the track universe context.
 */
function dds_track_preprocess_html(&$variables) {
  if (!_dds_track_is_track_universe() || \Drupal::service('router.admin_context')->isAdminRoute()) {
    return;
  }

  /** @var \Drupal\node\Entity\Node $node */
  $node = \Drupal::routeMatch()->getParameter('node');

  // Attach a general class we can use to style things like the header.
  $variables['attributes']['class'][] = 'page-type-universe';
  // Attach a specific track class that let us know at a high level what track
  // the node is.
  $variables['attributes']['class'][] = 'universe-' . $node->get('field_universe')->getString();
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Attach a html class to the node, if it's in a track-universe context.
 * This allows us to target nodes in teasers etc.
 */
function dds_track_preprocess_node(&$variables) {
  _dds_track_prepare_node_teaser($variables);
}

/**
 * Implements hook_preprocess_HOOK().
 */
function dds_track_preprocess_block(&$variables) {
  if ($variables['base_plugin_id'] != 'system_branding_block') {
    return;
  }

  if (!_dds_track_is_track_universe()) {
    return;
  }

  $theme_path = \Drupal::theme()->getActiveTheme()->getPath();
  $variables['track_logo'] = base_path() . $theme_path . '/assets/images/track/logo.svg';
}

/**
 * Helper function to check if the current node is in a track-context.
 *
 * @return bool
 *   Whether the current node is a track-universe or not.
 */
function _dds_track_is_track_universe(): bool {
  if (empty(\Drupal::routeMatch()->getParameter('node'))) {
    return FALSE;
  }

  /** @var \Drupal\node\Entity\Node $node */
  $node = \Drupal::routeMatch()->getParameter('node');
  if (!$node->hasField('field_universe')) {
    return FALSE;
  }

  $track_universe_options = _dds_track_get_universe_options();
  if (!in_array($node->get('field_universe')->getString(), $track_universe_options)) {
    return FALSE;
  }

  return TRUE;
}

/**
 * Helper function to get the possible values for the track universe.
 *
 * @return string[]
 *   Return an array of the possible options for the Track universe.
 */
function _dds_track_get_universe_options(): array {
  return [
    'track-skills',
    'track-patrol',
    'track-events',
    'track-adventure',
  ];
}

/**
 * Helper function to prepare track nodes in teasers.
 */
function _dds_track_prepare_node_teaser(&$variables) {
  if (empty($variables['node']) || !$variables['node'] instanceof Node) {
    return $variables;
  }

  // Bail out if view mode is not a teaser.
  if ($variables['view_mode'] === 'full' || $variables['view_mode'] === 'preview') {
    return $variables;
  }

  $node = $variables['node'];
  if (!$node->hasField('field_universe')) {
    return $variables;
  }

  if (!empty($node->get('field_universe')->getString())) {
    $variables['attributes']['class'][] = $node->get('field_universe')->getString();
  }
}
